<launch>
    <arg name="test_case"       default="0" />      <!-- 测试用例: 0=直线, 1=圆形, 2=正弦 -->
    <arg name="use_sim_time"    default="false" />  <!-- 是否使用仿真时间 -->
    

    <!-- 0. 使用仿真时间 -->
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true" />
    
    <!-- 1. 启动测试控制节点 -->
    <node pkg="control" type="test_control" name="test_control" output="screen">
        <!-- 测试用例选择 -->
        <param name="test_case"             value="$(arg test_case)" />

        <!-- 基本控制参数 -->
        <param name="lookahead_distance"    value="0.6" />
        <param name="max_linear_vel"        value="4.0" />
        <param name="max_angular_vel"       value="1.5" />
        <param name="control_frequency"     value="50.0" />
        <param name="goal_tolerance"        value="0.1" />
        <param name="min_trajectory_point_distance" value="0.2" />
        
        <!-- PID控制器参数 -->
        <param name="pid/linear/kp"         value="0.3" />
        <param name="pid/linear/ki"         value="0.01" />
        <param name="pid/linear/kd"         value="0.01" />
        <param name="pid/angular/kp"        value="2" />
        <param name="pid/angular/ki"        value="0.6" />
        <param name="pid/angular/kd"        value="0.1" />
        
        <!-- 话题重映射 -->
        <remap from="odom"                  to="/vehicle/odom" />                       <!-- 订阅车辆位姿和速度 -->
        <remap from="cmd_vel"               to="/test_control/cmd_vel" />               <!-- 发布车辆控制指令 -->
        <remap from="reference_trajectory"  to="/test_control/reference_trajectory" />  <!-- 发布参考轨迹 -->
        <remap from="actual_trajectory"     to="/test_control/actual_trajectory" />     <!-- 发布实际轨迹 -->
    </node>
    
    <!-- 2. 启动仿真环境 -->
    <node pkg="simulation" type="simulation" name="simulation" output="screen">
        <!-- 仿真参数 -->
        <param name="simulation_frequency"      value="100.0" />
        <param name="cmd_vel_timeout"           value="0.5" />
        <param name="world_frame"               value="/map" />
        <param name="robot_frame"               value="/veh" />
        
        <!-- 车辆参数 -->
        <param name="vehicle/length"            value="1.0" />
        <param name="vehicle/width"             value="0.4" />
        <param name="vehicle/max_linear_vel"    value="4.0" />
        <param name="vehicle/max_angular_vel"   value="1.5" />
        <param name="vehicle/max_linear_acc"    value="2.0" />
        <param name="vehicle/max_angular_acc"   value="1.0" />
        
        <!-- 初始位置 -->
        <param name="initial_position/x"        value="0.0" />
        <param name="initial_position/y"        value="0.0" />
        <param name="initial_position/theta"    value="0.3" />
        
        <!-- 噪声参数 -->
        <param name="noise/add_noise"           value="true" />
        <param name="noise/linear_stddev"       value="0.002" />
        <param name="noise/angular_stddev"      value="0.005" />
        <param name="noise/position_stddev"     value="0.0005" />
        <param name="noise/velocity_stddev"     value="0.001" />
        
        <!-- 话题重映射 -->
        <remap from="cmd_vel"        to="/test_control/cmd_vel" />  <!-- 订阅车辆控制指令 -->
        <remap from="odom"           to="/vehicle/odom" />          <!-- 发布车辆位姿和速度 -->
        <remap from="vehicle_marker" to="/vehicle/vehicle_marker" /><!-- 发布车辆形状可视化marker -->
    </node>

    <!-- 3. 启动plotter -->
    <!-- 启动PID绘图节点，目前不用，且不完善 -->
    <!-- <node pkg="control" type="plotter_node.py" name="pid_plotter" output="screen" respawn="false">
        <param name="max_data_points" value="2000" />
        <param name="plot_update_rate" value="5" />
        <param name="save_interval" value="10" />

        <remap from="odom"                  to="/vehicle/odom" />
        <remap from="reference_trajectory"  to="/test_control/reference_trajectory" />
        <remap from="actual_trajectory"     to="/test_control/actual_trajectory" />
    </node> -->

    <!-- 4. 启动rviz -->
    <node pkg="rviz" type="rviz" name="rviz" args="-d $(find control)/rviz/test_control.rviz" />

</launch>